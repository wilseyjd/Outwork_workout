# Outwork — Supabase Data Model (v1)

This document describes a recommended **Supabase (Postgres) schema** for the Outwork workout-tracking web app. It supports:

- **Planned workouts** (templates + targets)
- **Performed workouts** (sessions with actual sets)
- **Workout scheduling**
- **Supplement scheduling + logging**
- **Body weight tracking**
- **Optional attachments (images)** via Supabase Storage

---

## Design Principles

1. **Planned vs Performed**
   - A **Workout Template** defines the plan (targets).
   - A **Workout Session** records what actually happened.

2. **Mobile-first logging**
   - Optimize for fast “log set → save” workflows.
   - Store sets as rows (not JSON blobs) for easy querying.

3. **RLS everywhere**
   - Each user can only access their own rows.
   - Simplest approach: include `user_id` on all user-owned tables.

---

## Conventions

- Primary keys: `uuid` generated by `gen_random_uuid()`
- Time fields: `timestamptz` where appropriate
- Audit: `created_at` default `now()`
- Optional: `updated_at` with a trigger

---

## Core Tables

### 1) `profiles`
One row per user (maps to Supabase Auth).

| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) | equals `auth.users.id` |
| display_name | text | optional |
| units | text | default `'lbs'` |
| created_at | timestamptz | default `now()` |

**Relationships**
- `profiles.id` ← `user_id` in most tables

---

### 2) `exercises`
The user’s **Exercise Bank**.

| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) |  |
| user_id | uuid (FK → profiles.id) | owner |
| name | text | required |
| category | text | optional (push/pull/legs, cardio, etc.) |
| default_tracking | jsonb | e.g. `{ "weight": true, "reps": true, "time": false }` |
| notes | text | optional |
| created_at | timestamptz | default `now()` |
| updated_at | timestamptz | optional |

**Recommended indexes / constraints**
- Unique: `(user_id, lower(name))`
- Index: `(user_id, name)`

---

## Workout Planning (Templates)

### 3) `workout_templates`
The **planned workout** definition.

| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) |  |
| user_id | uuid (FK → profiles.id) | owner |
| name | text | required |
| notes | text | optional |
| created_at | timestamptz | default `now()` |
| updated_at | timestamptz | optional |

**Index**
- `(user_id, name)`

---

### 4) `workout_template_exercises`
Exercises included in a template, with ordering.

| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) |  |
| user_id | uuid (FK → profiles.id) | owner (simplifies RLS) |
| template_id | uuid (FK → workout_templates.id) | cascade on delete |
| exercise_id | uuid (FK → exercises.id) |  |
| position | int | ordering |
| notes | text | optional |
| created_at | timestamptz | default `now()` |

**Indexes**
- `(template_id, position)`
- `(exercise_id)`

---

### 5) `planned_sets`
Planned targets for each exercise within a template.

| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) |  |
| user_id | uuid (FK → profiles.id) | owner |
| template_exercise_id | uuid (FK → workout_template_exercises.id) | cascade on delete |
| set_number | int | 1..N |
| target_reps | int | nullable |
| target_weight | numeric | nullable (lbs) |
| target_time_seconds | int | nullable |
| rest_seconds | int | nullable |
| is_warmup | boolean | default false |

**Indexes**
- `(template_exercise_id, set_number)`

**Validation guidance**
- Allow weight OR time (or both) depending on exercise type.
- A simple check constraint can ensure at least one target exists if you want:
  - `(target_reps is not null) OR (target_weight is not null) OR (target_time_seconds is not null)`

---

## Workout Scheduling & Execution (Sessions)

### 6) `workout_schedule`
Assign a template to a specific day.

| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) |  |
| user_id | uuid (FK → profiles.id) | owner |
| template_id | uuid (FK → workout_templates.id) |  |
| scheduled_date | date |  |
| status | text | `planned` \| `completed` \| `skipped` |
| created_at | timestamptz | default `now()` |

**Recommended**
- Create a Postgres enum `schedule_status` for `status`.

**Indexes**
- `(user_id, scheduled_date)`
- `(template_id)`

---

### 7) `workout_sessions`
A **performed workout** instance (actual session).

| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) |  |
| user_id | uuid (FK → profiles.id) | owner |
| template_id | uuid (FK → workout_templates.id) | nullable for ad-hoc |
| schedule_id | uuid (FK → workout_schedule.id) | nullable |
| started_at | timestamptz | required |
| ended_at | timestamptz | nullable |
| notes | text | optional |
| created_at | timestamptz | default `now()` |

**Indexes**
- `(user_id, started_at desc)`
- `(template_id)`
- `(schedule_id)`

---

### 8) `session_exercises`
Snapshot of exercises in a session (ordered).

| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) |  |
| user_id | uuid (FK → profiles.id) | owner |
| session_id | uuid (FK → workout_sessions.id) | cascade on delete |
| exercise_id | uuid (FK → exercises.id) |  |
| position | int | ordering |
| notes | text | optional |
| created_at | timestamptz | default `now()` |

**Indexes**
- `(session_id, position)`
- `(exercise_id)`

---

### 9) `performed_sets`
Actual logged sets during a session.

| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) |  |
| user_id | uuid (FK → profiles.id) | owner |
| session_exercise_id | uuid (FK → session_exercises.id) | cascade on delete |
| set_number | int | 1..N |
| actual_reps | int | nullable |
| actual_weight | numeric | nullable (lbs) |
| actual_time_seconds | int | nullable |
| rest_seconds | int | nullable |
| is_warmup | boolean | default false |
| created_at | timestamptz | default `now()` |

**Indexes**
- `(session_exercise_id, set_number)`
- **Progression query support:** join via `session_exercises.exercise_id`, so index:
  - `(user_id, created_at desc)`
  - `(user_id, session_exercise_id)`

---

## Supplements

### 10) `supplements`
Defines a supplement the user takes.

| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) |  |
| user_id | uuid (FK → profiles.id) | owner |
| name | text | required |
| default_dose | text | e.g., `5g`, `200mg` |
| notes | text | optional |
| created_at | timestamptz | default `now()` |
| updated_at | timestamptz | optional |

**Indexes**
- Unique `(user_id, lower(name))`

---

### 11) `supplement_schedule`
How/when a supplement should be taken.

| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) |  |
| user_id | uuid (FK → profiles.id) | owner |
| supplement_id | uuid (FK → supplements.id) | cascade on delete |
| schedule_type | text | `daily` \| `weekly` \| `custom` |
| time_of_day | time | nullable |
| days_of_week | int[] | nullable (1–7) |
| dose | text | nullable; fallback to `default_dose` |
| active | boolean | default true |
| created_at | timestamptz | default `now()` |

**Recommended**
- Use Postgres enum `supplement_schedule_type`.

**Indexes**
- `(user_id, active)`
- `(supplement_id)`

---

### 12) `supplement_logs`
Actual intake logs.

| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) |  |
| user_id | uuid (FK → profiles.id) | owner |
| supplement_id | uuid (FK → supplements.id) |  |
| taken_at | timestamptz | required |
| dose | text | required |
| notes | text | optional |

**Indexes**
- `(user_id, taken_at desc)`
- `(supplement_id, taken_at desc)`

---

## Body Weight

### 13) `body_weight_logs`
Track body weight over time.

| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) |  |
| user_id | uuid (FK → profiles.id) | owner |
| logged_at | timestamptz | default `now()` |
| weight_lbs | numeric | required |
| notes | text | optional |

**Indexes**
- `(user_id, logged_at desc)`

---

## Attachments (Images)

### 14) `attachments`
Metadata for files stored in Supabase Storage.

| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) |  |
| user_id | uuid (FK → profiles.id) | owner |
| entity_type | text | e.g., `workout_session`, `exercise` |
| entity_id | uuid | the row id being attached to |
| storage_path | text | path in bucket |
| caption | text | optional |
| created_at | timestamptz | default `now()` |

**Storage suggestion**
- Bucket: `outwork-attachments`
- Path format: `{user_id}/{entity_type}/{entity_id}/{filename}`

**Indexes**
- `(user_id, entity_type, entity_id)`

---

## Key Relationships (ERD-style summary)

- `profiles (1) → (many) exercises`
- `profiles (1) → (many) workout_templates`
- `workout_templates (1) → (many) workout_template_exercises`
- `workout_template_exercises (1) → (many) planned_sets`
- `workout_templates (1) → (many) workout_schedule`
- `workout_schedule (optional 1) → (0..1) workout_sessions`
- `workout_sessions (1) → (many) session_exercises`
- `session_exercises (1) → (many) performed_sets`
- `supplements (1) → (many) supplement_schedule`
- `supplements (1) → (many) supplement_logs`
- `profiles (1) → (many) body_weight_logs`
- `profiles (1) → (many) attachments`

---

## Common Queries You’ll Want

### “What did I lift last time for Bench Press?”
1. Find `exercise_id` for “Bench Press”
2. Join:
   - `performed_sets` → `session_exercises` (by `session_exercise_id`)
   - Filter `session_exercises.exercise_id = :exercise_id`
   - Order by `performed_sets.created_at desc`
   - Take the most recent set (or most recent session)

### Volume trend over time (per exercise)
- Sum `actual_weight * actual_reps` grouped by week (or by session date)

### Today’s scheduled workout
- `workout_schedule` where `scheduled_date = current_date` and status = planned
- Load template → exercises → planned sets

---

## Row Level Security (RLS) Recommendations

Enable RLS on all tables and apply policies like:

- SELECT: `user_id = auth.uid()`
- INSERT: `user_id = auth.uid()`
- UPDATE: `user_id = auth.uid()`
- DELETE: `user_id = auth.uid()`

> If you keep `user_id` on *all* tables, RLS stays simple and fast.  
> If you omit `user_id` on join tables, you’ll need subqueries that check ownership via the parent relationship.

---

## Optional Enhancements (Later)

- Add `muscle_group` and `equipment` to `exercises`
- Add `tags` to templates/sessions
- Add `personal_records` materialized view (max weight, best reps, best volume)
- Add `exercise_aliases` table for flexible search
